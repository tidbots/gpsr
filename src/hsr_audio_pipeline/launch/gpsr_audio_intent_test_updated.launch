<launch>
  <!-- gpsr_audio_intent_test.launch (updated)
       End-to-end: audio_capture -> (Silero VAD) -> Faster-Whisper ASR -> GPSR Parser -> /gpsr/intent
       Vocab/corrections are expected under /data/vocab (volume-mounted).
  -->

  <!-- ===== Vocab / dictionaries ===== -->
  <arg name="vocab_dir"        default="/data/vocab"/>
  <arg name="vocab_yaml"       default="$(arg vocab_dir)/vocab.yaml"/>
  <arg name="corrections_yaml" default="$(arg vocab_dir)/corrections.yaml"/>

  <!-- Optional MD vocab sources (gpsr_parser_node will auto-use if present, else fallback to vocab_yaml) -->
  <arg name="names_md"         default="$(arg vocab_dir)/names.md"/>
  <arg name="rooms_md"         default="$(arg vocab_dir)/room_names.md"/>
  <arg name="locations_md"     default="$(arg vocab_dir)/location_names.md"/>
  <arg name="objects_md"       default="$(arg vocab_dir)/objects.md"/>
  <arg name="test_objects_md"  default="$(arg vocab_dir)/test_objects.md"/>

  <!-- ===== Topics ===== -->
  <arg name="audio_topic"        default="/audio/audio"/>
  <arg name="vad_topic"          default="/vad/is_speech"/>
  <arg name="asr_raw_text_topic" default="/gpsr/asr/raw_text"/>
  <arg name="asr_text_topic"     default="/gpsr/asr/text"/>
  <arg name="asr_conf_topic"     default="/gpsr/asr/confidence"/>
  <arg name="utt_end_topic"      default="/gpsr/asr/utterance_end"/>
  <arg name="intent_topic"       default="/gpsr/intent"/>

  <!-- ===== Switches ===== -->
  <arg name="start_rms_monitor"  default="false"/>
  <arg name="start_vad"          default="true"/>
  <arg name="start_intent_backup" default="false"/>

  <!-- =======================
       audio_capture
       ======================= -->
  <node pkg="audio_capture" type="audio_capture" name="audio_capture" ns="audio" output="screen">
    <param name="sample_rate"    value="16000" />
    <param name="channels"       value="1" />
    <param name="format"         value="wave" />
    <param name="sample_format"  value="S16LE" />
    <param name="device"         value="" />
  </node>

  <!-- =======================
       Optional: RMS monitor
       ======================= -->
  <group if="$(arg start_rms_monitor)">
    <node pkg="hsr_audio_pipeline" type="audio_rms_monitor.py" name="audio_rms_monitor" output="screen">
      <param name="topic"         value="$(arg audio_topic)" />
      <param name="sample_format" value="S16LE" />
      <param name="log_interval"  value="50" />
    </node>
  </group>

  <!-- =======================
       Silero VAD
       ======================= -->
  <group if="$(arg start_vad)">
    <node pkg="hsr_audio_pipeline" type="silero_vad_node.py" name="silero_vad" output="screen">
      <param name="audio_topic" value="$(arg audio_topic)" />
      <param name="vad_topic"   value="$(arg vad_topic)" />
      <param name="sample_rate" value="16000" />
      <param name="chunk_size"  value="512" />

      <param name="speech_threshold"  value="0.6" />
      <param name="silence_threshold" value="0.3" />
      <param name="hangover_ms"       value="400" />

      <!-- persistent torch cache -->
      <param name="torch_home"    value="/data/models/torch" />
      <param name="torch_hub_dir" value="/data/models/torch/hub" />
    </node>
  </group>

  <!-- =======================
       Faster-Whisper ASR
       ======================= -->
  <node pkg="hsr_audio_pipeline" type="faster_whisper_asr_node.py"
        name="faster_whisper_asr_node" output="screen">

    <!-- Inputs -->
    <param name="audio_topic" value="$(arg audio_topic)" />
    <param name="vad_topic"   value="$(arg vad_topic)" />
    <param name="sample_rate" value="16000" />
    <param name="sample_width" value="2" />
    <param name="channels" value="1" />

    <!-- Outputs -->
    <param name="raw_text_topic"       value="$(arg asr_raw_text_topic)" />
    <param name="text_topic"           value="$(arg asr_text_topic)" />
    <param name="confidence_topic"     value="$(arg asr_conf_topic)" />
    <param name="utterance_end_topic"  value="$(arg utt_end_topic)" />

    <!-- persistent caches -->
    <param name="model_cache_dir" value="/data/models/hf" />
    <param name="torch_home"      value="/data/models/torch" />

    <!-- Vocab / corrections (for hotwording & correction) -->
    <param name="vocab_yaml"       value="$(arg vocab_yaml)"/>
    <param name="corrections_yaml" value="$(arg corrections_yaml)"/>
    <param name="use_hotwords"     value="true"/>

    <param name="vocab_dir"        value="$(arg vocab_dir)"/>
    <param name="names_md"         value="$(arg names_md)"/>
    <param name="rooms_md"         value="$(arg rooms_md)"/>
    <param name="locations_md"     value="$(arg locations_md)"/>
    <param name="objects_md"       value="$(arg objects_md)"/>
    <param name="test_objects_md"  value="$(arg test_objects_md)"/>

    <!-- Model -->
    <param name="model_size"    value="small" />
    <param name="device"        value="cpu" />           <!-- GPU: cuda -->
    <param name="compute_type"  value="float32" />       <!-- GPU: float16 -->
    <param name="language"      value="en" />

    <!-- Segmentation -->
    <param name="pre_roll"        value="0.25" />
    <param name="post_roll"       value="0.35" />
    <param name="min_segment_sec" value="0.6" />
    <param name="max_segment_sec" value="18.0" />
  </node>

  <!-- =======================
       GPSR Parser
       ======================= -->
  <node pkg="hsr_audio_pipeline" type="gpsr_parser_node.py"
        name="gpsr_parser_node" output="screen">
    <param name="text_topic"           value="$(arg asr_text_topic)" />
    <param name="utterance_end_topic"  value="$(arg utt_end_topic)" />
    <param name="confidence_topic"     value="$(arg asr_conf_topic)" />
    <param name="intent_topic"         value="$(arg intent_topic)" />

    <!-- vocab -->
    <param name="vocab_dir"       value="$(arg vocab_dir)"/>
    <param name="vocab_yaml"      value="$(arg vocab_yaml)"/>
    <param name="names_md"        value="$(arg names_md)"/>
    <param name="rooms_md"        value="$(arg rooms_md)"/>
    <param name="locations_md"    value="$(arg locations_md)"/>
    <param name="objects_md"      value="$(arg objects_md)"/>
    <param name="test_objects_md" value="$(arg test_objects_md)"/>

    <!-- behavior -->
    <param name="max_text_age_sec"        value="30.0"/>
    <param name="min_confidence"          value="-1.0"/>
    <param name="utt_end_retry_count"     value="8"/>
    <param name="utt_end_retry_sleep"     value="0.02"/>
    <param name="debounce_same_text_sec"  value="1.5"/>
  </node>

  <!-- =======================
       Optional backup intent extractor
       ======================= -->
  <group if="$(arg start_intent_backup)">
    <node pkg="hsr_audio_pipeline" type="gpsr_intent_node.py"
          name="gpsr_intent_node_backup" output="screen">
      <param name="text_topic" value="$(arg asr_text_topic)" />
      <param name="confidence_topic" value="$(arg asr_conf_topic)" />
      <param name="intent_topic" value="/gpsr/intent_alt" />
      <param name="confirm_threshold" value="-1.0" />
    </node>
  </group>

</launch>
