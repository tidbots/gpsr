<launch>
  <!-- gpsr_audio_intent_test.launch (LATEST)
       End-to-end: audio_capture -> (audio_rms_monitor) -> (Silero VAD) -> faster_whisper_asr_node -> gpsr_parser_node
       Notes:
         - /gpsr/intent is often used by legacy nodes with different message types.
           To avoid conflicts, this launch publishes JSON intent to /gpsr/intent_json by default.
         - Vocab/corrections are expected under /data/vocab (volume-mounted).
  -->

  <!-- =======================
       Arguments
       ======================= -->
  <!-- Audio -->
  <arg name="sample_rate"        default="16000"/>
  <arg name="channels"           default="1"/>
  <arg name="sample_format"      default="S16LE"/>
  <arg name="format"             default="wave"/>

  <!-- Optional utilities -->
  <arg name="start_rms_monitor"  default="true"/>
  <arg name="start_vad"          default="true"/>

  <!-- ASR topics -->
  <arg name="asr_text_topic"     default="/gpsr/asr/text"/>
  <arg name="asr_conf_topic"     default="/gpsr/asr/confidence"/>
  <arg name="utt_end_topic"      default="/gpsr/asr/utterance_end"/>

  <!-- VAD topic -->
  <arg name="vad_topic"          default="/vad/is_speech"/>

  <!-- Intent output (JSON string) -->
  <arg name="intent_topic"       default="/gpsr/intent_json"/>

  <!-- Vocab / dictionaries -->
  <arg name="vocab_dir"          default="/data/vocab"/>
  <arg name="vocab_yaml"         default="$(arg vocab_dir)/vocab.yaml"/>
  <arg name="corrections_yaml"   default="$(arg vocab_dir)/corrections.yaml"/>

  <!-- Optional MD vocab sources -->
  <arg name="names_md"           default="$(arg vocab_dir)/names.md"/>
  <arg name="rooms_md"           default="$(arg vocab_dir)/room_names.md"/>
  <arg name="locations_md"       default="$(arg vocab_dir)/location_names.md"/>
  <arg name="objects_md"         default="$(arg vocab_dir)/objects.md"/>
  <arg name="test_objects_md"    default="$(arg vocab_dir)/test_objects.md"/>

  <!-- Models cache -->
  <arg name="model_cache_dir"    default="/data/models/hf"/>
  <arg name="torch_home"         default="/data/models/torch"/>
  <arg name="torch_hub_dir"      default="/data/models/torch/hub"/>

  <!-- ASR model -->
  <arg name="language"           default="en"/>
  <arg name="model_size"         default="small"/>
  <arg name="device"             default="cpu"/>       <!-- set to cuda for GPU -->
  <arg name="compute_type"       default="float32"/>   <!-- float16 for GPU -->

  <!-- =======================
       Audio capture
       ======================= -->
  <node pkg="audio_capture" type="audio_capture" name="audio_capture" output="screen">
    <param name="sample_rate"    value="$(arg sample_rate)"/>
    <param name="channels"       value="$(arg channels)"/>
    <param name="sample_format"  value="$(arg sample_format)"/>
    <param name="format"         value="$(arg format)"/>
  </node>

  <!-- =======================
       Optional monitors
       ======================= -->
  <group if="$(arg start_rms_monitor)">
    <node pkg="hsr_audio_pipeline" type="audio_rms_monitor.py" name="audio_rms_monitor" output="screen">
      <param name="audio_topic" value="/audio"/>
    </node>
  </group>

  <group if="$(arg start_vad)">
    <node pkg="hsr_audio_pipeline" type="silero_vad_node.py" name="silero_vad" output="screen">
      <param name="audio_topic"        value="/audio"/>
      <param name="vad_topic"          value="$(arg vad_topic)"/>
      <param name="sample_rate"        value="$(arg sample_rate)"/>
      <param name="chunk_size"         value="512"/>
      <param name="speech_threshold"   value="0.55"/>
      <param name="silence_threshold"  value="0.35"/>
      <param name="hangover_ms"        value="250"/>
      <param name="torch_home"         value="$(arg torch_home)"/>
      <param name="torch_hub_dir"      value="$(arg torch_hub_dir)"/>
    </node>
  </group>

  <!-- =======================
       ASR (Faster-Whisper)
       ======================= -->
  <node pkg="hsr_audio_pipeline" type="faster_whisper_asr_node.py"
        name="faster_whisper_asr_node" output="screen">
    <param name="audio_topic"         value="/audio"/>
    <param name="vad_topic"           value="$(arg vad_topic)"/>
    <param name="text_topic"          value="$(arg asr_text_topic)"/>
    <param name="confidence_topic"    value="$(arg asr_conf_topic)"/>
    <param name="utterance_end_topic" value="$(arg utt_end_topic)"/>

    <param name="language"            value="$(arg language)"/>
    <param name="model_size"          value="$(arg model_size)"/>
    <param name="device"              value="$(arg device)"/>
    <param name="compute_type"        value="$(arg compute_type)"/>

    <param name="sample_rate"         value="$(arg sample_rate)"/>
    <param name="channels"            value="$(arg channels)"/>

    <param name="pre_roll" value="0.35"/>
    <param name="post_roll" value="0.45"/>
    <param name="max_segment_sec" value="22.0"/>
    <param name="finalize_cooldown_sec" value="0.8"/>

    <param name="vocab_dir"           value="$(arg vocab_dir)"/>
    <param name="vocab_yaml"          value="$(arg vocab_yaml)"/>
    <param name="corrections_yaml"    value="$(arg corrections_yaml)"/>
    <param name="names_md"            value="$(arg names_md)"/>
    <param name="rooms_md"            value="$(arg rooms_md)"/>
    <param name="locations_md"        value="$(arg locations_md)"/>
    <param name="objects_md"          value="$(arg objects_md)"/>
    <param name="test_objects_md"     value="$(arg test_objects_md)"/>

    <param name="model_cache_dir"     value="$(arg model_cache_dir)"/>
    <param name="torch_home"          value="$(arg torch_home)"/>
  </node>

  <!-- =======================
       GPSR Parser (JSON intent)
       ======================= -->
  <node pkg="hsr_audio_pipeline" type="gpsr_parser_node.py"
        name="gpsr_parser_node" output="screen">
    <param name="text_topic"              value="$(arg asr_text_topic)"/>
    <param name="confidence_topic"        value="$(arg asr_conf_topic)"/>
    <param name="utterance_end_topic"     value="$(arg utt_end_topic)"/>
    <param name="intent_topic"            value="$(arg intent_topic)"/>

    <param name="vocab_dir"               value="$(arg vocab_dir)"/>
    <param name="vocab_yaml"              value="$(arg vocab_yaml)"/>
    <param name="names_md"                value="$(arg names_md)"/>
    <param name="rooms_md"                value="$(arg rooms_md)"/>
    <param name="locations_md"            value="$(arg locations_md)"/>
    <param name="objects_md"              value="$(arg objects_md)"/>
    <param name="test_objects_md"         value="$(arg test_objects_md)"/>

    <!-- behavior -->
    <param name="max_text_age_sec"        value="30.0"/>
    <param name="min_confidence"          value="-1.0"/>
    <param name="debounce_same_text_sec"  value="1.5"/>
  </node>

</launch>
