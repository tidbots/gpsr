<launch>
  <!-- gpsr_audio_intent_test.launch (UPDATED)
       Single-source GPSR pipeline using gpsr_parser_node only.
       Legacy NLU nodes are intentionally NOT launched.
  -->

  <!-- ===== Audio ===== -->
  <node pkg="audio_capture" type="audio_capture" name="audio_capture" output="screen">
    <param name="sample_rate" value="16000"/>
    <param name="channels" value="1"/>
    <param name="sample_format" value="S16LE"/>
    <param name="format" value="wave"/>
  </node>

  <!-- ===== Optional monitors ===== -->
  <node pkg="hsr_audio_pipeline" type="audio_rms_monitor.py" name="audio_rms_monitor" output="screen" />

  <node pkg="hsr_audio_pipeline" type="silero_vad_node.py" name="silero_vad" output="screen">
    <param name="audio_topic" value="/audio/audio"/>
    <param name="vad_topic" value="/vad/is_speech"/>
    <param name="sample_rate" value="16000"/>
    <param name="chunk_size" value="512"/>
    <param name="speech_threshold" value="0.6"/>
    <param name="silence_threshold" value="0.3"/>
    <param name="hangover_ms" value="400"/>
    <param name="torch_home" value="/data/models/torch"/>
    <param name="torch_hub_dir" value="/data/models/torch/hub"/>
  </node>

  <!-- ===== ASR ===== -->
  <node pkg="hsr_audio_pipeline" type="faster_whisper_asr_node.py"
        name="faster_whisper_asr_node" output="screen">
    <param name="audio_topic" value="/audio/audio"/>
    <param name="vad_topic" value="/vad/is_speech"/>
    <param name="text_topic" value="/gpsr/asr/text"/>
    <param name="confidence_topic" value="/gpsr/asr/confidence"/>
    <param name="utterance_end_topic" value="/gpsr/asr/utterance_end"/>

    <param name="language" value="en"/>
    <param name="model_size" value="small"/>
    <param name="device" value="cpu"/>
    <param name="compute_type" value="float32"/>

    <param name="sample_rate" value="16000"/>
    <param name="channels" value="1"/>

    <param name="vocab_dir" value="/data/vocab"/>
    <param name="vocab_yaml" value="/data/vocab/vocab.yaml"/>
    <param name="corrections_yaml" value="/data/vocab/corrections.yaml"/>
    <param name="names_md" value="/data/vocab/names.md"/>
    <param name="rooms_md" value="/data/vocab/room_names.md"/>
    <param name="locations_md" value="/data/vocab/location_names.md"/>
    <param name="objects_md" value="/data/vocab/objects.md"/>
    <param name="test_objects_md" value="/data/vocab/test_objects.md"/>

    <param name="model_cache_dir" value="/data/models/hf"/>
    <param name="torch_home" value="/data/models/torch"/>
  </node>

  <!-- ===== GPSR Parser (ONLY source of /gpsr/intent) ===== -->
  <node pkg="hsr_audio_pipeline" type="gpsr_parser_node.py"
        name="gpsr_parser_node" output="screen">
    <param name="text_topic" value="/gpsr/asr/text"/>
    <param name="confidence_topic" value="/gpsr/asr/confidence"/>
    <param name="utterance_end_topic" value="/gpsr/asr/utterance_end"/>
    <param name="intent_topic" value="/gpsr/intent_json"/>

    <param name="vocab_dir" value="/data/vocab"/>
    <param name="vocab_yaml" value="/data/vocab/vocab.yaml"/>
    <param name="names_md" value="/data/vocab/names.md"/>
    <param name="rooms_md" value="/data/vocab/room_names.md"/>
    <param name="locations_md" value="/data/vocab/location_names.md"/>
    <param name="objects_md" value="/data/vocab/objects.md"/>
    <param name="test_objects_md" value="/data/vocab/test_objects.md"/>

    <param name="max_text_age_sec" value="30.0"/>
    <param name="min_confidence" value="-1.0"/>
    <param name="debounce_same_text_sec" value="1.5"/>
  </node>

</launch>
